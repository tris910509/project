<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halaman Transaksi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h2 class="text-center">Halaman Transaksi</h2>

        <!-- Form Input Transaksi -->
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">Input Transaksi</h5>
                <form id="transaksiForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="pelanggan" class="form-label">Pelanggan</label>
                            <select class="form-select" id="pelanggan">
                                <option value="" disabled selected>Pilih Pelanggan</option>
                                <option value="Umum">Pelanggan Umum</option>
                                <!-- Daftar pelanggan member akan diisi dari localStorage -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="tanggalTransaksi" class="form-label">Tanggal Transaksi</label>
                            <input type="date" class="form-control" id="tanggalTransaksi">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="produk" class="form-label">Produk</label>
                            <select class="form-select" id="produk">
                                <option value="" disabled selected>Pilih Produk</option>
                                <!-- Produk akan diisi dari localStorage -->
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="jumlah" class="form-label">Jumlah</label>
                            <input type="number" class="form-control" id="jumlah" min="1" value="1">
                        </div>
                        <div class="col-md-3">
                            <label for="potonganHarga" class="form-label">Potongan Harga (Rp)</label>
                            <input type="number" class="form-control" id="potonganHarga" min="0" value="0">
                        </div>
                    </div>

                    <button type="button" class="btn btn-primary" id="tambahKeranjang">Tambah ke Keranjang</button>
                </form>
            </div>
        </div>

        <!-- Tabel Keranjang -->
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">Keranjang</h5>
                <table class="table table-striped" id="keranjangTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Produk</th>
                            <th>Jumlah</th>
                            <th>Potongan Harga</th>
                            <th>Subtotal</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div class="text-end">
                    <h5>Total: Rp <span id="totalHarga">0</span></h5>
                </div>
            </div>
        </div>

        <!-- Proses Pembayaran -->
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">Proses Pembayaran</h5>
                <form id="pembayaranForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="metodePembayaran" class="form-label">Metode Pembayaran</label>
                            <select class="form-select" id="metodePembayaran">
                                <option value="Cash">Cash</option>
                                <option value="Transfer">Transfer</option>
                                <option value="QR">QR</option>
                                <option value="Ewallet">Ewallet</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="jumlahBayar" class="form-label">Jumlah Bayar</label>
                            <input type="number" class="form-control" id="jumlahBayar" min="0">
                        </div>
                    </div>

                    <div class="text-end">
                        <button type="button" class="btn btn-success" id="prosesPembayaran">Proses Pembayaran</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const pelangganList = JSON.parse(localStorage.getItem('pelanggan')) || [];
        const produkList = JSON.parse(localStorage.getItem('produk')) || [];
        const transaksiList = JSON.parse(localStorage.getItem('transaksi')) || [];

        let keranjang = [];
        let totalHarga = 0;

        // Atur tanggal transaksi otomatis ke hari ini
        document.getElementById('tanggalTransaksi').valueAsDate = new Date();

        // Render daftar pelanggan ke dropdown
        function renderPelanggan() {
            const pelangganDropdown = document.getElementById('pelanggan');
            pelangganList.forEach(pelanggan => {
                const option = document.createElement('option');
                option.value = pelanggan.nama;
                option.textContent = pelanggan.nama;
                pelangganDropdown.appendChild(option);
            });
        }

        // Render daftar produk ke dropdown
        function renderProduk() {
            const produkDropdown = document.getElementById('produk');
            produkList.forEach(produk => {
                const option = document.createElement('option');
                option.value = produk.nama;
                option.textContent = produk.nama;
                produkDropdown.appendChild(option);
            });
        }

        // Tambahkan item ke keranjang
        document.getElementById('tambahKeranjang').addEventListener('click', () => {
            const produk = document.getElementById('produk').value;
            const jumlah = parseInt(document.getElementById('jumlah').value);
            const potonganHarga = parseInt(document.getElementById('potonganHarga').value) || 0;

            if (!produk || jumlah < 1) {
                alert('Pilih produk dan jumlah dengan benar.');
                return;
            }

            const item = produkList.find(p => p.nama === produk);
            const subtotal = (item.harga * jumlah) - potonganHarga;

            keranjang.push({ nama: produk, jumlah, potonganHarga, subtotal });
            totalHarga += subtotal;

            renderKeranjang();
        });

        // Render keranjang ke tabel
        function renderKeranjang() {
            const keranjangTable = document.querySelector('#keranjangTable tbody');
            keranjangTable.innerHTML = '';

            keranjang.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.nama}</td>
                    <td>${item.jumlah}</td>
                    <td>Rp ${item.potonganHarga.toFixed(2)}</td>
                    <td>Rp ${item.subtotal.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="hapusItem(${index})">Hapus</button>
                    </td>
                `;
                keranjangTable.appendChild(row);
            });

            document.getElementById('totalHarga').textContent = totalHarga.toFixed(2);
        }

        // Hapus item dari keranjang
        function hapusItem(index) {
            totalHarga -= keranjang[index].subtotal;
            keranjang.splice(index, 1);
            renderKeranjang();
        }

        // Proses pembayaran
        document.getElementById('prosesPembayaran').addEventListener('click', () => {
            const pelanggan = document.getElementById('pelanggan').value || 'Umum';
            const tanggal = document.getElementById('tanggalTransaksi').value;
            const metodePembayaran = document.getElementById('metodePembayaran').value;
            const jumlahBayar = parseInt(document.getElementById('jumlahBayar').value);

            if (jumlahBayar < totalHarga) {
                alert('Jumlah bayar kurang dari total harga. Konfirmasi diperlukan.');
                return;
            }

            const kembalian = jumlahBayar - totalHarga;

            const transaksi = {
                pelanggan,
                date: tanggal,
                keranjang,
                metodePembayaran,
                total: totalHarga,
                status: jumlahBayar >= totalHarga ? 'Lunas' : 'Belum Lunas',
            };

            transaksiList.push(transaksi);
            localStorage.setItem('transaksi', JSON.stringify(transaksiList));

            alert(`Transaksi berhasil! Kembalian: Rp ${kembalian.toFixed(2)}`);
            window.location.reload();
        });

        // Render pelanggan dan produk saat halaman dimuat
        document.addEventListener('DOMContentLoaded', () => {
            renderPelanggan();
            renderProduk();
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaksi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <script>
        // Periksa peran pengguna
        const role = localStorage.getItem('userRole');
        const allowedRoles = ['Admin', 'Kasir'];
        if (!allowedRoles.includes(role)) {
            alert('Anda tidak memiliki akses ke halaman ini!');
            window.location.href = 'login.html';
        }
    </script>

    <div class="container mt-5">
        <h2 class="text-center">Halaman Transaksi</h2>

        <!-- Form Transaksi -->
        <form id="transaksiForm">
            <div class="mb-3">
                <label for="transaksiId" class="form-label">ID Transaksi</label>
                <input type="text" class="form-control" id="transaksiId" placeholder="ID Transaksi" readonly>
            </div>

            <div class="mb-3">
                <label for="pelanggan" class="form-label">Pelanggan</label>
                <select class="form-select" id="pelanggan">
                    <option value="Pelanggan Umum">Pelanggan Umum</option>
                    <option value="Pelanggan Member">Pelanggan Member</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="produk" class="form-label">Produk</label>
                <select class="form-select" id="produk">
                    <!-- Produk akan ditambahkan secara dinamis -->
                </select>
            </div>

            <div class="mb-3">
                <label for="jumlah" class="form-label">Jumlah</label>
                <input type="number" class="form-control" id="jumlah" value="1" min="1">
            </div>

            <div class="mb-3">
                <label for="totalHarga" class="form-label">Total Harga</label>
                <input type="number" class="form-control" id="totalHarga" readonly>
            </div>

            <button type="button" class="btn btn-primary" id="addToCart">Tambah ke Keranjang</button>
        </form>

        <hr>

        <h4>Keranjang Belanja</h4>
        <table class="table" id="keranjangTable">
            <thead>
                <tr>
                    <th>Produk</th>
                    <th>Jumlah</th>
                    <th>Total Harga</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody>
                <!-- Data keranjang akan muncul di sini -->
            </tbody>
        </table>

        <button class="btn btn-success" id="prosesPembayaran">Proses Pembayaran</button>
    </div>

    <script>
        let produkList = [
            { id: 1, name: 'Produk A', harga: 50000 },
            { id: 2, name: 'Produk B', harga: 70000 },
            { id: 3, name: 'Produk C', harga: 30000 }
        ];

        let keranjang = [];
        let transaksiList = JSON.parse(localStorage.getItem('transaksi')) || [];

        // Fungsi untuk mengupdate tabel keranjang
        function updateKeranjangTable() {
            const keranjangTable = document.getElementById('keranjangTable').getElementsByTagName('tbody')[0];
            keranjangTable.innerHTML = '';
            keranjang.forEach(item => {
                const row = keranjangTable.insertRow();
                row.insertCell(0).innerText = item.name;
                row.insertCell(1).innerText = item.jumlah;
                row.insertCell(2).innerText = `Rp ${item.totalHarga}`;
                const deleteBtn = row.insertCell(3);
                deleteBtn.innerHTML = '<button class="btn btn-danger btn-sm" onclick="removeFromCart(' + item.id + ')">Hapus</button>';
            });
        }

        // Fungsi untuk menambahkan produk ke keranjang
        document.getElementById('addToCart').addEventListener('click', function() {
            const produkId = parseInt(document.getElementById('produk').value);
            const jumlah = parseInt(document.getElementById('jumlah').value);
            const produk = produkList.find(p => p.id === produkId);

            if (produk) {
                const totalHarga = produk.harga * jumlah;
                keranjang.push({ id: produk.id, name: produk.name, jumlah: jumlah, totalHarga: totalHarga });
                updateKeranjangTable();
            }
        });

        // Fungsi untuk menghapus produk dari keranjang
        function removeFromCart(id) {
            keranjang = keranjang.filter(item => item.id !== id);
            updateKeranjangTable();
        }

        // Fungsi untuk menghasilkan ID Transaksi unik
        function generateTransaksiId() {
            return 'TRX-' + Date.now();
        }

        // Fungsi untuk proses pembayaran
        document.getElementById('prosesPembayaran').addEventListener('click', function() {
            if (keranjang.length === 0) {
                alert('Keranjang masih kosong!');
                return;
            }

            const transaksiId = generateTransaksiId();
            const pelanggan = document.getElementById('pelanggan').value;
            let totalTransaksi = 0;

            // Hitung total harga
            keranjang.forEach(item => totalTransaksi += item.totalHarga);

            // Buat transaksi baru
            const transaksi = {
                id: transaksiId,
                pelanggan: pelanggan,
                items: keranjang,
                total: totalTransaksi,
                status: 'Belum Lunas',
                metodePembayaran: 'Belum Dibayar'
            };

            // Simpan transaksi ke dalam localStorage
            transaksiList.push(transaksi);
            localStorage.setItem('transaksi', JSON.stringify(transaksiList));

            // Tampilkan ID transaksi
            document.getElementById('transaksiId').value = transaksiId;

            alert('Transaksi berhasil! ID Transaksi: ' + transaksiId);
        });

        // Isi produk pada dropdown
        window.onload = function() {
            const produkSelect = document.getElementById('produk');
            produkList.forEach(produk => {
                const option = document.createElement('option');
                option.value = produk.id;
                option.text = produk.name;
                produkSelect.add(option);
            };
        };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

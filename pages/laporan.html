<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Transaksi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h2 class="text-center">Laporan Transaksi</h2>

        <!-- Statistik Transaksi -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Total Transaksi</h5>
                        <h3 id="totalTransaksi">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Total Pelanggan</h5>
                        <h3 id="totalPelanggan">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Total Pendapatan</h5>
                        <h3 id="totalPendapatan">Rp 0</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter dan Ekspor -->
        <div class="row mb-4">
            <div class="col-md-3">
                <label for="filterTanggal" class="form-label">Filter Tanggal</label>
                <input type="date" id="filterTanggal" class="form-control">
            </div>
            <div class="col-md-3">
                <label for="filterStatus" class="form-label">Filter Status</label>
                <select id="filterStatus" class="form-control">
                    <option value="">Semua Status</option>
                    <option value="Lunas">Lunas</option>
                    <option value="Belum Lunas">Belum Lunas</option>
                    <option value="Pending">Pending</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="filterPelanggan" class="form-label">Filter Pelanggan</label>
                <input type="text" id="filterPelanggan" class="form-control" placeholder="Nama Pelanggan">
            </div>
            <div class="col-md-3 text-end">
                <button class="btn btn-success mt-4" id="exportCSV">Ekspor CSV</button>
            </div>
        </div>

        <!-- Tabel Laporan -->
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>#</th>
                    <th>ID Transaksi</th>
                    <th>Tanggal</th>
                    <th>Pelanggan</th>
                    <th>Metode Pembayaran</th>
                    <th>Status</th>
                    <th>Total</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody id="laporanTable">
                <!-- Data akan diisi melalui JavaScript -->
            </tbody>
        </table>
    </div>

    <!-- Modal Detail Transaksi -->
    <div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailModalLabel">Detail Transaksi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul id="detailList">
                        <!-- Detail transaksi -->
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const transaksiList = JSON.parse(localStorage.getItem('transaksi')) || [];

        // Fungsi untuk memformat angka menjadi format Rupiah
        function formatRupiah(angka) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
            }).format(angka);
        }

        // Render statistik transaksi
        function renderStatistik() {
            const totalTransaksi = transaksiList.length;
            const pelangganSet = new Set(transaksiList.map(t => t.pelanggan));
            const totalPendapatan = transaksiList.reduce((sum, transaksi) => sum + transaksi.total, 0);

            document.getElementById('totalTransaksi').innerText = totalTransaksi;
            document.getElementById('totalPelanggan').innerText = pelangganSet.size;
            document.getElementById('totalPendapatan').innerText = formatRupiah(totalPendapatan);
        }

        // Render laporan transaksi
        function renderLaporan() {
            const filterTanggal = document.getElementById('filterTanggal').value;
            const filterStatus = document.getElementById('filterStatus').value;
            const filterPelanggan = document.getElementById('filterPelanggan').value.toLowerCase();

            const laporanTable = document.getElementById('laporanTable');
            laporanTable.innerHTML = '';

            const filteredTransaksi = transaksiList.filter(transaksi => {
                const matchTanggal =
                    !filterTanggal || transaksi.tanggal === filterTanggal;
                const matchStatus =
                    !filterStatus || transaksi.status === filterStatus;
                const matchPelanggan =
                    !filterPelanggan || transaksi.pelanggan.toLowerCase().includes(filterPelanggan);

                return matchTanggal && matchStatus && matchPelanggan;
            });

            filteredTransaksi.forEach((transaksi, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${transaksi.id}</td>
                    <td>${transaksi.tanggal}</td>
                    <td>${transaksi.pelanggan}</td>
                    <td>${transaksi.metodePembayaran}</td>
                    <td>${transaksi.status}</td>
                    <td>${formatRupiah(transaksi.total)}</td>
                    <td>
                        <button class="btn btn-info btn-sm" onclick="showDetailModal(${index})">Detail</button>
                    </td>
                `;
                laporanTable.appendChild(row);
            });
        }

        // Tampilkan modal detail transaksi
        function showDetailModal(index) {
            const transaksi = transaksiList[index];
            const detailList = document.getElementById('detailList');
            detailList.innerHTML = `
                <li><strong>ID Transaksi:</strong> ${transaksi.id}</li>
                <li><strong>Tanggal:</strong> ${transaksi.tanggal}</li>
                <li><strong>Pelanggan:</strong> ${transaksi.pelanggan}</li>
                <li><strong>Metode Pembayaran:</strong> ${transaksi.metodePembayaran}</li>
                <li><strong>Status:</strong> ${transaksi.status}</li>
                <li><strong>Produk:</strong></li>
                <ul>
                    ${transaksi.produk.map(p => `<li>${p.nama} (${p.jumlah}x) - ${formatRupiah(p.harga)}</li>`).join('')}
                </ul>
                <li><strong>Total:</strong> ${formatRupiah(transaksi.total)}</li>
            `;

            const detailModal = new bootstrap.Modal(document.getElementById('detailModal'));
            detailModal.show();
        }

        // Ekspor laporan ke CSV
        function exportCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "ID Transaksi,Tanggal,Pelanggan,Metode Pembayaran,Status,Total\n";
            transaksiList.forEach(transaksi => {
                csvContent += `${transaksi.id},${transaksi.tanggal},${transaksi.pelanggan},${transaksi.metodePembayaran},${transaksi.status},${transaksi.total}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "laporan_transaksi.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        document.getElementById('exportCSV').addEventListener('click', exportCSV);

        renderStatistik();
        renderLaporan();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
